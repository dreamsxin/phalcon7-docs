<!DOCTYPE html>

<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>单元测试（Unit testing） &mdash; Phalcon7 1.3.2 文档</title>
    <meta name="keywords" content="php, phalcon, phalcon7, phalcon php, php framework, faster php framework">
    <link rel="stylesheet" type="text/css" href="../static/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../static/phalcon.css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.3.2',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script src="../static/jquery.min.js"></script>
    <link rel="shortcut icon" href="../static/img/favicon.ico"/>
    <link rel="top" title="Phalcon7 1.3.2 文档" href="../index.html" />
    <link rel="next" title="图形库（Chart）" href="chart.html" />
    <link rel="prev" title="数据库迁移（Database Migrations）" href="migrations.html" /> 
</head>
<body>

<header class="page-header">
<nav class="navbar" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-container">
				<span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
			</button>
			<a class="navbar-brand phalcon-logo" href="/"><span itemprop="name" class="sr-only">Phalcon PHP</span></a>
		</div>

		<div class="collapse navbar-collapse navbar-right" id="main-menu-container">
			<ul class="nav navbar-nav main-menu">
			  <li class="first"><a href="https://github.com/dreamsxin/cphalcon7" class="header-nav-link">GitHub</a></li>
			  <li class="first"><a href="https://github.com/dreamsxin/cphalcon7/releases" class="header-nav-link">Download</a></li>
			  <li class="first"><a href="/api/" class="header-nav-link">API</a></li>
			  <li class="first"><a href="/internals/" class="header-nav-link">内核开发手册</a></li>
			</ul>
		</div>
	</div>
</nav>
</header>

<div class="heading">
    <div class="container">
        <div class="row">
            <h2>Documentation</h2>
        </div>
    </div>
</div>


<div class="container-fluid">
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="总目录"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="chart.html" title="图形库（Chart）"
             accesskey="N">下一页</a> |</li>
        <li class="right" >
          <a href="migrations.html" title="数据库迁移（Database Migrations）"
             accesskey="P">上一页</a> |</li>
        <li><a href="http://myleftstudio.com">Home</a> &raquo;</li>
        <li><a href="../index.html">Phalcon7 1.3.2 文档</a> &raquo;</li> 
      </ul>
    </div>  
</div>

<div class="container-fluid">
	<div class="col-md-3 primary-box">
		<div class="panel panel-default">
			<div class="panel-heading"><a href="../index.html">內容目录</a></div>
			<div class="panel-body"><ul>
<li><a class="reference internal" href="#">单元测试（Unit testing）</a><ul>
<li><a class="reference internal" href="#phpunit-phalcon-integrating-phpunit-with-phalcon">整合 PHPunit 到 phalcon（Integrating PHPunit with phalcon）</a></li>
<li><a class="reference internal" href="#phpunit-the-phpunit-helper-file">PHPunit 辅助文件（The PHPunit helper file）</a></li>
<li><a class="reference internal" href="#phpunit-xml-phpunit-xml-file">PHPunit.xml 文件（PHPunit.xml file）</a></li>
<li><a class="reference internal" href="#sample-unit-test">简单的单元测试（Sample unit test）</a></li>
</ul>
</li>
</ul>
</div>
			<div class="panel-heading">上一个主题</div>
            <div class="panel-body"><p class="topless"><a href="migrations.html" title="上一章">&lt; 数据库迁移（Database Migrations）</a></p></div>
			<div class="panel-heading">下一个主题</div>
            <div class="panel-body"><p class="topless"><a href="chart.html" title="下一章">图形库（Chart） &gt;</a></p></div>
		</div>
	</div>
  <div class="col-md-9 second-box" valign="top">
	<div class="document">
		<div class="documentwrapper">
		  <div class="bodywrapper">
			<div class="body" >
			  
  <div class="section" id="unit-testing">
<h1>单元测试（Unit testing）<a class="headerlink" href="#unit-testing" title="永久链接至标题">¶</a></h1>
<p>Writing proper tests can assist in writing better software. If you set up proper test cases you can eliminate most functional bugs and better maintain your software.</p>
<div class="section" id="phpunit-phalcon-integrating-phpunit-with-phalcon">
<h2>整合 PHPunit 到 phalcon（Integrating PHPunit with phalcon）<a class="headerlink" href="#phpunit-phalcon-integrating-phpunit-with-phalcon" title="永久链接至标题">¶</a></h2>
<p>If you don&#8217;t already have phpunit installed, you can do it by using the following composer command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>composer require phpunit/phpunit
</pre></div>
</div>
<p>or by manually adding it to composer.json:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;require-dev&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;phpunit/phpunit&quot;</span><span class="p">:</span> <span class="s2">&quot;~4.5&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Once phpunit is installed create a directory called &#8216;tests&#8217; in your root directory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>app/
public/
tests/
</pre></div>
</div>
<p>Next, we need a &#8216;helper&#8217; file to bootstrap the application for unit testing.</p>
</div>
<div class="section" id="phpunit-the-phpunit-helper-file">
<h2>PHPunit 辅助文件（The PHPunit helper file）<a class="headerlink" href="#phpunit-the-phpunit-helper-file" title="永久链接至标题">¶</a></h2>
<p>A helper file is required to bootstrap the application for running the tests. We have prepared a sample file. Put the file in your tests/ directory as TestHelper.php.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Di</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Di\FactoryDefault</span><span class="p">;</span>

<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;display_errors&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="nb">error_reporting</span><span class="p">(</span><span class="k">E_ALL</span><span class="p">);</span>

<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;ROOT_PATH&#39;</span><span class="p">,</span> <span class="no">__DIR__</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;PATH_LIBRARY&#39;</span><span class="p">,</span> <span class="no">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/../app/library/&#39;</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;PATH_SERVICES&#39;</span><span class="p">,</span> <span class="no">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/../app/services/&#39;</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">&#39;PATH_RESOURCES&#39;</span><span class="p">,</span> <span class="no">__DIR__</span> <span class="o">.</span> <span class="s1">&#39;/../app/resources/&#39;</span><span class="p">);</span>

<span class="nb">set_include_path</span><span class="p">(</span>
    <span class="nx">ROOT_PATH</span> <span class="o">.</span> <span class="nx">PATH_SEPARATOR</span> <span class="o">.</span> <span class="nb">get_include_path</span><span class="p">()</span>
<span class="p">);</span>

<span class="c1">// Required for phalcon/incubator</span>
<span class="k">include</span> <span class="no">__DIR__</span> <span class="o">.</span> <span class="s2">&quot;/../vendor/autoload.php&quot;</span><span class="p">;</span>

<span class="c1">// Use the application autoloader to autoload the classes</span>
<span class="c1">// Autoload the dependencies found in composer</span>
<span class="nv">$loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Phalcon\Loader</span><span class="p">();</span>

<span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">registerDirs</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span>
        <span class="nx">ROOT_PATH</span>
    <span class="p">)</span>
<span class="p">);</span>

<span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">();</span>

<span class="nv">$di</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FactoryDefault</span><span class="p">();</span>
<span class="nx">Di</span><span class="o">::</span><span class="na">reset</span><span class="p">();</span>

<span class="c1">// Add any needed services to the DI here</span>

<span class="nx">Di</span><span class="o">::</span><span class="na">setDefault</span><span class="p">(</span><span class="nv">$di</span><span class="p">);</span>
</pre></div>
</div>
<p>Should you need to test any components from your own library, add them to the autoloader or use the autoloader from your main application.</p>
<p>To help you build the unit tests, we made a few abstract classes you can use to bootstrap the unit tests themselves.
These files exist in the Phalcon incubator &#64; <a class="reference external" href="https://github.com/phalcon/incubator">https://github.com/phalcon/incubator</a>.</p>
<p>You can use the incubator library by adding it as a dependency:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>composer require phalcon/incubator
</pre></div>
</div>
<p>or by manually adding it to composer.json:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;require&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;phalcon/incubator&quot;</span><span class="p">:</span> <span class="s2">&quot;dev-master&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also clone the repository using the repo link above.</p>
</div>
<div class="section" id="phpunit-xml-phpunit-xml-file">
<h2>PHPunit.xml 文件（PHPunit.xml file）<a class="headerlink" href="#phpunit-xml-phpunit-xml-file" title="永久链接至标题">¶</a></h2>
<p>Now, create a phpunit file:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;phpunit</span> <span class="na">bootstrap=</span><span class="s">&quot;./TestHelper.php&quot;</span>
         <span class="na">backupGlobals=</span><span class="s">&quot;false&quot;</span>
         <span class="na">backupStaticAttributes=</span><span class="s">&quot;false&quot;</span>
         <span class="na">verbose=</span><span class="s">&quot;true&quot;</span>
         <span class="na">colors=</span><span class="s">&quot;false&quot;</span>
         <span class="na">convertErrorsToExceptions=</span><span class="s">&quot;true&quot;</span>
         <span class="na">convertNoticesToExceptions=</span><span class="s">&quot;true&quot;</span>
         <span class="na">convertWarningsToExceptions=</span><span class="s">&quot;true&quot;</span>
         <span class="na">processIsolation=</span><span class="s">&quot;false&quot;</span>
         <span class="na">stopOnFailure=</span><span class="s">&quot;false&quot;</span>
         <span class="na">syntaxCheck=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">&quot;Phalcon - Testsuite&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;directory&gt;</span>./<span class="nt">&lt;/directory&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
<span class="nt">&lt;/phpunit&gt;</span>
</pre></div>
</div>
<p>Modify the phpunit.xml to fit your needs and save it in tests/.</p>
<p>This will run any tests under the tests/ directory.</p>
</div>
<div class="section" id="sample-unit-test">
<h2>简单的单元测试（Sample unit test）<a class="headerlink" href="#sample-unit-test" title="永久链接至标题">¶</a></h2>
<p>To run any unit tests you need to define them. The autoloader will make sure the proper files are loaded so all you need to do is create the files and phpunit will run the tests for you.</p>
<p>This example does not contain a config file, most test cases however, do need one. You can add it to the DI to get the UnitTestCase file.</p>
<p>First create a base unit test called UnitTestCase.php in your /tests directory:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Phalcon\Di</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Phalcon\Test\UnitTestCase</span> <span class="k">as</span> <span class="nx">PhalconTestCase</span><span class="p">;</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">UnitTestCase</span> <span class="k">extends</span> <span class="nx">PhalconTestCase</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var \Voice\Cache</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$_cache</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var \Phalcon\Config</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$_config</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var bool</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$_loaded</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">setUp</span><span class="p">();</span>

        <span class="c1">// Load any additional services that might be required during testing</span>
        <span class="nv">$di</span> <span class="o">=</span> <span class="nx">Di</span><span class="o">::</span><span class="na">getDefault</span><span class="p">();</span>

        <span class="c1">// Get any DI components here. If you have a config, be sure to pass it to the parent</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setDi</span><span class="p">(</span><span class="nv">$di</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_loaded</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * Check if the test case is setup properly</span>
<span class="sd">     *</span>
<span class="sd">     * @throws \PHPUnit_Framework_IncompleteTestError;</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__destruct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_loaded</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\PHPUnit_Framework_IncompleteTestError</span><span class="p">(</span><span class="s1">&#39;Please run parent::setUp().&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It&#8217;s always a good idea to separate your Unit tests in namespaces. For this test we will create the namespace &#8216;Test&#8217;. So create a file called testsTestUnitTest.php:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Test</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * Class UnitTest</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">UnitTest</span> <span class="k">extends</span> <span class="nx">\UnitTestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">testTestCase</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;works&#39;</span><span class="p">,</span>
            <span class="s1">&#39;works&#39;</span><span class="p">,</span>
            <span class="s1">&#39;This is OK&#39;</span>
        <span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEquals</span><span class="p">(</span><span class="s1">&#39;works&#39;</span><span class="p">,</span>
            <span class="s1">&#39;works1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;This will fail&#39;</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now when you execute &#8216;phpunit&#8217; in your command-line from the tests directory you will get the following output:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ phpunit
PHPUnit <span class="m">3</span>.7.23 by Sebastian Bergmann.

Configuration <span class="nb">read</span> from /private/var/www/tests/phpunit.xml

Time: <span class="m">3</span> ms, Memory: <span class="m">3</span>.25Mb

There was <span class="m">1</span> failure:

<span class="m">1</span><span class="o">)</span> Test<span class="se">\U</span>nitTest::testTestCase
This will fail
Failed asserting that two strings are equal.
--- Expected
+++ Actual
@@ @@
-<span class="s1">&#39;works&#39;</span>
+<span class="s1">&#39;works1&#39;</span>

/private/var/www/tests/Test/UnitTest.php:25

FAILURES!
Tests: <span class="m">1</span>, Assertions: <span class="m">2</span>, Failures: <span class="m">1</span>.
</pre></div>
</div>
<p>Now you can start building your unit tests. You can view a good guide here (we also recommend reading the PHPunit documentation if you&#8217;re not familiar with PHPunit):</p>
<p><a class="reference external" href="http://blog.stevensanderson.com/2009/08/24/writing-great-unit-tests-best-and-worst-practises/">http://blog.stevensanderson.com/2009/08/24/writing-great-unit-tests-best-and-worst-practises/</a></p>
</div>
</div>


			</div>
		  </div>
		</div>
	</div>
  </div>
</div>
    <div class="related">
      <ul>
        <li class="right" >
          <a href="../genindex.html" title="总目录"
             >索引</a></li>
        <li class="right" >
          <a href="chart.html" title="图形库（Chart）"
             >下一页</a> |</li>
        <li class="right" >
          <a href="migrations.html" title="数据库迁移（Database Migrations）"
             >上一页</a> |</li> 
      </ul>
    </div>

<footer class="footer">
	<div class="container">
      <div class="row">
          <div class="col-xs-6 col-sm-3">
              <h4>Download</h4>
              <ul>
                  <li><a href="https://github.com/dreamsxin/cphalcon7/releases">安裝 Phalcon7</a></li>
              </ul>
          </div>
          <div class="col-xs-6 col-sm-3">
              <h4>Community</h4>
              <ul>
                  <li><a href="https://github.com/dreamsxin/cphalcon7">GitHub</a></li>
                  <li><a href="https://github.com/dreamsxin/cphalcon7/issues">Issue Tracker</a></li>
              </ul>
          </div>
          <div class="col-xs-6 col-sm-2">
              <h4>About</h4>
              <ul>
                  <li><a href="https://github.com/dreamsxin/cphalcon/wiki/%E6%8D%90%E8%B5%A0%EF%BC%88Donation%EF%BC%89">Donate</a></li>
              </ul>
          </div>
          <div id="license-spaccer" class="visible-xs"></div>
          <div id="license-wrapper" class="col-xs-12 col-sm-4">
              <p class="license">

                  Phalcon7 Framework is released under the <a href="https://github.com/dreamsxin/cphalcon7/blob/master/docs/LICENSE.md">new BSD license</a>.<br>
                  Except where otherwise noted, content on this site is licensed under the
                  <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 License.</a>
              </p>
              <div class="design">
                  <span>Designed by:</span>

                  <a href="http://www.fog-city.net/" class="fogcity" target="_blank" title="Fog City Software"><span>Fog City Software</span></a>
              </div>
          </div>
      </div>
	</div>
</footer>
</body>
</html>